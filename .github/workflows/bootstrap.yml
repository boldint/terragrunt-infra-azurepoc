name: Bootstrap action for Terraform Cloud

on: workflow_dispatch

jobs:
  bootstrap_tfc:
    name: Bootstrap TFC
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Get global variables
        id: get_global_var
        run: |
          echo "::set-output name=tfc_organization::$(grep -w entity common.hcl | cut -d'=' -f2 | tr -d '" ')"
          echo "::set-output name=tfc_organization_email::$(grep -w entity_email common.hcl | cut -d'=' -f2 | tr -d '" ')"
          echo "::set-output name=tfc_workspace_unit::$(grep -w unit common.hcl | cut -d'=' -f2 | tr -d '" ')"
          echo "::set-output name=tfc_workspace_projectappservice::$(grep -w "projectappservice"  common.hcl | cut -d'=' -f2 | tr -d '" ')"

      - name: Get deployments (location / environment)
        id: get_deployments
        run: |
          deployments=$(dirname $(find . -type f -name terragrunt.hcl ! -path '*/.terragrunt-cache/*' ! -path './terragrunt.hcl') | cut -d/ -f2- | tr / - | tr '\n' ' ')
          echo "::set-output name=deployments::$deployments"

      - name: Construct Workspace names
        id: construct_ws_names
        run: |
          prepend="${{ steps.get_global_var.outputs.tfc_workspace_unit }}-${{ steps.get_global_var.outputs.tfc_workspace_projectappservice }}-"
          array( ${{ steps.get_deployments.outputs.deployments }})
          array=( "${array[@]/#/$prepend}" )
          echo "::set-output name=workspaces::${array[@]}"

      - name: Bootstrap
        id: bootstrap
        run: |
          echo "Óráite!"
