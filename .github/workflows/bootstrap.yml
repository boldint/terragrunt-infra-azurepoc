name: Bootstrap action for Terraform Cloud

on: workflow_dispatch

jobs:
  bootstrap_tfc:
    name: Bootstrap TFC
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        
      - name: Get global variables
        id: get_global_var
        run: |
          echo "::set-output name=tfc_organization::$(grep -w entity common.hcl | cut -d'=' -f2 | tr -d '" ')"
          echo "::set-output name=tfc_organization_email::$(grep -w entity_email common.hcl | cut -d'=' -f2 | tr -d '" ')"
          echo "::set-output name=tfc_workspace_unit::$(grep -w unit common.hcl | cut -d'=' -f2 | tr -d '" ')"
          echo "::set-output name=tfc_workspace_projectappservice::$(grep -w "projectappservice"  common.hcl | cut -d'=' -f2 | tr -d '" ')"

      - name: Get deployments (location / environment)
        # This step will calculate the deployments, based on the location of terragrunt.hcl
        # files and will output them as white space separated string, with no leading or
        # ending white spaces.
        id: get_deployments
        run: |
          deployments=$(dirname $(find . -type f -name terragrunt.hcl ! -path '*/.terragrunt-cache/*' ! -path './terragrunt.hcl') | cut -d/ -f2- | tr / - | tr '\n' ' ')
          echo "::set-output name=deployments::${deployments%?}"

      - name: Construct Workspace names
        # This step will append the global naming prefix to the above returned deployments
        # and output the full workspace names as a white space separated string.
        id: construct_ws_names
        run: |
          prepend="${{ steps.get_global_var.outputs.tfc_workspace_unit }}-${{ steps.get_global_var.outputs.tfc_workspace_projectappservice }}-"
          ws_array=(${{ steps.get_deployments.outputs.deployments }})
          ws_array=( "${ws_array[@]/#/$prepend}" )
          echo "::set-output name=workspaces::${ws_array[@]}"

      - name: Bootstrap
        id: bootstrap
        uses: boldint/tfc-org-setup-action@AP-1
        with:
          organization: ${{ steps.get_global_var.outputs.tfc_organization }}
          organization_email: ${{ steps.get_global_var.outputs.tfc_organization_email }}
          workspaces: ${{ steps.construct_ws_names.outputs.workspaces }}
          token: ${{ secrets.TF_API_TOKEN }}
